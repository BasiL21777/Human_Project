<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Patient Records</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .admin-container {
      background-color: var(--neuro-dark, #0a0a1a);
      color: var(--neuro-light, #e0f8ff);
      padding: 2rem 3rem;
      min-height: 70vh;
      font-family: 'Poppins', sans-serif;
    }
    h1 { color: var(--neuro-primary, #6e00ff); user-select: none; }
    .table-responsive { max-width:100%; overflow-x:auto; }
    .record-table { width:100%; border-collapse:collapse; font-size:0.95rem;
      box-shadow:0 0 30px rgba(110,0,255,0.15); border-radius:15px; overflow:hidden; }
    .record-table thead { background-color:var(--neuro-primary,#6e00ff); color:var(--neuro-dark,#0a0a1a); }
    .record-table th,.record-table td { padding:0.75rem 1.25rem; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
    .record-table tbody tr:hover { background-color:rgba(110,0,255,0.1); }
    .badge-success { background-color:#00ff88; color:#0a0a1a; padding:0.3rem 0.6rem; border-radius:12px; }
    .badge-danger { background-color:#ff3860; color:#fff; padding:0.3rem 0.6rem; border-radius:12px; }
    .btn-sm { padding:0.3rem 0.8rem; border-radius:20px; font-size:0.8rem; margin-right:0.3rem; cursor:pointer; border:none; }
    .btn-info { background-color:#00f0ff; color:#0a0a1a; }
    .btn-delete { background-color:#ff1444; color:#fff; }
  </style>
</head>
<body>
<div class="admin-container">
  <h1>Manage Patient Records</h1>

  <!-- Records Table -->
  <div class="table-responsive">
    <table class="record-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Patient</th>
          <th>Doctor</th>
          <th>Draft</th>
          <th>Created</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="recordsBody"></tbody>
    </table>
  </div>
</div>

<script>
const BASE_URL = "http://localhost:5000";
const API_PREFIX = "/"; // keep consistent with your controllers

async function loadRecords(){
  const token = localStorage.getItem("access_token");
  try {
    // Get all records (Admin only per your backend)
    const res = await fetch(`${BASE_URL}/patient_Record/`, {
      headers:{ Authorization:`Bearer ${token}` }
    });
    const json = await res.json();
    const records = json.data || [];
    const body = document.getElementById("recordsBody");
    body.innerHTML = "";

    records.forEach(r=>{
      const draftBadge = r.is_draft
        ? '<span class="badge-danger">Draft</span>'
        : '<span class="badge-success">Final</span>';

      const actionBtns = `
        <button class="btn-sm btn-info" onclick="showDetails('${r._id}')">Details</button>
        <button class="btn-sm btn-delete" onclick="deleteRecord('${r._id}')">Delete</button>
      `;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r._id}</td>
        <td>${r.patient_id?.email || ''}</td>
        <td>${r.doctor_id?.email || ''}</td>
        <td>${draftBadge}</td>
        <td>${r.created_at ? new Date(r.created_at).toLocaleDateString() : ''}</td>
        <td>${r.updated_at ? new Date(r.updated_at).toLocaleDateString() : ''}</td>
        <td>${actionBtns}</td>
      `;
      body.appendChild(row);
    });
  } catch(err){ console.error("Error loading records:", err); }
}

async function deleteRecord(id){
  const token = localStorage.getItem("access_token");
  if(!confirm("Are you sure you want to delete this record?")) return;
  try {
    const res = await fetch(`${BASE_URL}/patient_Record/${id}`, {
      method:"DELETE",
      headers:{ Authorization:`Bearer ${token}` }
    });
    if(res.ok){
      alert("Record deleted successfully");
      loadRecords();
    } else {
      const errData = await res.json();
      alert("Error deleting record: "+(errData.error || res.status));
    }
  } catch(err){ console.error("Delete error:", err); }
}

function showDetails(id){
  // Navigate to details page with query param
  window.location.href = `/admin/patient_record_details.html?id=${id}`;
}

// Run on page load
loadRecords();
</script>
</body>
</html>
